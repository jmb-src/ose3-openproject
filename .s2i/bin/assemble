#!/bin/bash
set -xe

if [ "$(ls /tmp/artifacts/ 2>/dev/null)" ]; then
  echo "---> Restoring build artifacts"
  mv /tmp/artifacts/* $HOME/.
fi

echo "---> Installing application source..."
cp -Rf /tmp/src/. ./

sed -i /^ruby/d Gemfile

#scl enable rh-nodejs4 "npm install -g npm@4.0 bower"
sed -ie '/^\s*links.*api_experimental_query_path(query).*$/ { N; d; }' app/controllers/api/experimental/concerns/query_loading.rb

# delete existing directory
rm -rf /opt/app-root/src/files
ln -snf /opt/app-root/data/files /opt/app-root/src/files

# retry if it fails
scl enable rh-ruby23 "bundle install --path .bundle --jobs 4 || bundle || bundle"

scl enable rh-nodejs4 "cd frontend && npm install && bower install --allow-root"
scl enable rh-ruby23 rh-nodejs4 "DATABASE_URL=sqlite3:///tmp/db.sqlite3 bundle exec rake assets:precompile"

mkdir -p /opt/app-root/data
chmod -R go+rwX /opt/app-root/{src,data}
